---
title: "TopdownApproach"
author: "Jinshi"
date: "May 19, 2019"
output:
  word_document: default
  html_document: default
---


```{r}
# To do list and questions
# 1. Savanna and grassland more than 20% area, but sample numbers are too small for Frrot, RC, and Ra/Gpp ratio
# 2. Ra < 0 how to resolve this 
```

## Abbreviation
* Rroot - root respiration
* Rshoot - shoot respiration
* Rs - soil respiration
* Ra - autotrophic respiration (Rroot + Rshoot)
* GPP - gross primary production
* NPP - net primary production
* NEP - net ecosystem production

* Froot - Rroot / Ra (root autotrophic respiration to total autotrophic respiration fraction/ratio, calculation please see plot_froot function)
* Fshoot - Rshoot / Ra (1-Froot)
* FsFr - (1-Froot)/Froot (FsFr = Rshoot/Rroot ratio)
* RC - (root respiration / soil respiration)
* RaGPP - (Ra/GPP) ratio


### Assumptions
* Bottom-up approach: 
  1. We collected published global soil respiration estimates
  2. We then partition Rs into root respiration and belowground heterotrophic resipiration
  3. We also collected published NPP estimates in the past decades from ITO et al. (2011)
  4. We then collected (and calculated) Rroot/Ra ratio, according to the root respiration, GPP can be calculates as (NPP + Rroot + Rshoot)
  5. We then compare this bottomup GPP with published GPP in the past decades (n=65) to see how much probability they will match

* Top-down approach:
  1. We first collect global GPP estimates in the past decades
  2. We then estimate Ra according to Ra/GPP ratio and GPP-NPP
  3. Heterotrophic respiration was estimated according to Rh = NPP - HerbComsum - Fire - Csink (NEP)
  4. Rs_topdown =  Rh + Rroot
  5. We then compare this top-down Rs with published Rs in the past decades (n=27)n to see how much probability they will match
  
### Questions and more anlysis in the future
* How unlikely is it that we can reconcile current Rs and GPP estimates? 
  E.g. what % of the distribution of each 'allows' us to match the central estimate of the other? (<30%)
* What is driving the differences between botton-up GPP and reported GPP and top-down Rs and reported Rs?
* How do we resolve this? Where is better/more data needed? 
* These questions all resolve around influence x uncertainty = importance, right? This is basically the 'Dietze graph'.
* Which is more likely, low GPP or high Rs? -- discussion

### Importance/implication/benifits
* Provide another way to estimate GPP and Rs
* Provide a method to compare bottom-up GPP (start from field Rs/Froot/RC/Rroot measurements, then modelling to estimate GPP) with remote sensing or land model GPP.
* Provide a method to compare top-down Rs (Rs seperated from remote sensing land model based GPP) with filed experiment based Rs (field Rs measurement, then modeling).


```{r}
# install.packages('kableExtra')
# Load required packages
library(data.table)

library(lubridate)
library(kableExtra)
library(cowplot)
library(knitr)
library("ggpubr")
library(reshape)
library(ggplot2)
# install.packages("ggmap")
library(ggmap)
# install.packages("maps")
library(maps)
# install.packages("mapdata")
library(mapdata)
library(tidyr)
library(hexbin)
library(cowplot)
library(dplyr)
# Source all needed functions
library(ggplot2)
theme_set(theme_bw())

source('functions.R')
```


```{r preliminaries, message=FALSE, include=FALSE, echo=FALSE, cache=TRUE}
# Set chunks defaults; these options will be applied to all subsequent chunks
knitr::opts_chunk$set(results = 'hide', message = TRUE, include = TRUE, echo = FALSE,
                      fig.height = 4, fig.width = 8, cache = TRUE)
# Constants
OUTPUT_DIR		<- "outputs/"
SEPARATOR		<- "-------------------------------------------"
DATA_DIR <- 'data'
# Create output and log folders if they do not exist
if(!file.exists(OUTPUT_DIR)) dir.create(OUTPUT_DIR)
```



```{r}
# input data
srdb_v4 <- read.csv(file.path(DATA_DIR, 'srdbv4.csv')) # SRDB_V4 data
FlFsFr <- read.csv(file.path(DATA_DIR, 'FlFsFrSummary.csv')) # Froot (Rroot/Rs) and Fshoot (Rshoot/Rs) from 39 papers
GPP <- read.csv(file.path(DATA_DIR, 'GlobalGPP_Sum.csv')) # 65 GPP estimates from published paper
NPP <- read.csv(file.path(DATA_DIR, 'ITONPP.CSV')) # 251 NPP estimates from ITO (2011)
GlobalRs <- read.csv(file.path(DATA_DIR, 'GlobalRs.csv')) # 27 estimates of global Rs
# (Ra/GPP) Piao, Shilong, et al. "Forest annual carbon cost: A globalâ€scale analysis of autotrophic respiration." Ecology 91.3 (2010): 652-661.
RaGPP <- read.csv(file.path(DATA_DIR, 'RaGPP.csv')) 
IGBP <- read.table(file.path(DATA_DIR, 'IGBP.txt'), header = TRUE, sep = ",")
# sort(unique(IGBP$IGBP2001Pr))
# There are 16 IGBP group
IGBP %>% mutate(IGBP = case_when( IGBP2001Pr == 0 ~ "WAT",
                                  IGBP2001Pr == 1 ~ "ENF",
                                  IGBP2001Pr == 2 ~ "EBF",
                                  IGBP2001Pr == 3 ~ "DNF",
                                  IGBP2001Pr == 4 ~ "DBF",
                                  IGBP2001Pr == 5 ~ "MF",
                                  IGBP2001Pr == 6 ~ "CSH",
                                  IGBP2001Pr == 7 ~ "OSH",
                                  IGBP2001Pr == 8 ~ "WSA",
                                  IGBP2001Pr == 9 ~ "SAV",
                                  IGBP2001Pr == 10 ~ "GRA",
                                  IGBP2001Pr == 11 ~ "WET",
                                  IGBP2001Pr == 12 ~ "CRO",
                                  IGBP2001Pr == 13 ~ "URB",
                                  IGBP2001Pr == 14 ~ "CVM",
                                  IGBP2001Pr == 15 ~ "SNO",
                                  IGBP2001Pr == 16 ~ "BSV",
                                  TRUE ~ "UNC" ) ) -> IGBP

# BBL: Interesting; I didn't know case_when! Aanother way to do this would be 
# IGBP_list <- c("WAT", "ENF", ...)
# IGBP$IGBP <- IGBP_list[IGBP$IGBP2001Pr]

# 16 IGBP group into 10 Ecosystems
IGBP %>% mutate (Ecosystem = case_when( IGBP2001Pr == 0 ~ "Water",
                                        IGBP2001Pr == 1 ~ "Forest",
                                        IGBP2001Pr == 2 ~ "Forest",
                                        IGBP2001Pr == 3 ~ "Forest",
                                        IGBP2001Pr == 4 ~ "Forest",
                                        IGBP2001Pr == 5 ~ "Forest",
                                        IGBP2001Pr == 6 ~ "Shrubland",
                                        IGBP2001Pr == 7 ~ "Shrubland",
                                        IGBP2001Pr == 8 ~ "Savanna",
                                        IGBP2001Pr == 9 ~ "Savanna",
                                        IGBP2001Pr == 10 ~ "Grassland",
                                        IGBP2001Pr == 11 ~ "Wetland",
                                        IGBP2001Pr == 12 ~ "Agriculture",
                                        IGBP2001Pr == 13 ~ "Urbland",
                                        IGBP2001Pr == 14 ~ "Agriculture",
                                        IGBP2001Pr == 15 ~ "Snow",
                                        IGBP2001Pr == 16 ~ "Desert",
                                        TRUE ~ "Unclassified")) -> IGBP
# DGRsD <- read.csv(paste0(DATA_DIR,'/', 'DGRsD.csv'), header = TRUE)

AGB <- read.table(paste0(DATA_DIR,'/', 'GLC2000_Point.txt'), header = T, sep = ",")
AGB %>% filter(RASTERVALU != -9999) -> AGB
SOC <- read.table(paste0(DATA_DIR,'/', 'SOC_Point.txt'), header = T, sep = ",")
```


```{r}
head(AGB)
max(AGB$RASTERVALU)
min(AGB$RASTERVALU)

max(SOC$RASTERVALU)
min(SOC$RASTERVALU)
```



```{r}
# IGBP area by type
IGBP %>% 
  filter(Ecosystem != "Water", Ecosystem != "Snow",
         Ecosystem != "Unclassified", Ecosystem != "Urbland") %>%  
  group_by(Ecosystem) %>% 
  summarise(count = n()) %>% 
  mutate(percent = count / sum(count))
# sum(0.191,0.17,0.214,0.153,0.155,0.113,0.004)

# Remove desert and shrubland because no data for Froot and Ra/GPP ratio
IGBP %>% 
  filter(Ecosystem != "Water", Ecosystem != "Snow",
         Ecosystem != "Unclassified", Ecosystem != "Urbland",
         Ecosystem != "Desert", Ecosystem != "Shrubland") %>%  
  group_by(Ecosystem) %>% summarise ( count = n() ) %>% mutate (percent = count/sum(count))
sum(0.267,0.298,0.213,0.216,0.006)
```





```{r}
# plot Ra Rs relationship
# Ra_Rs_relationship <- function (sdata) {
#   sdata$Ra_Norm <- ifelse (is.na(sdata$Ra_Norm), sdata$RS_Norm - sdata$Rh_Norm, sdata$Ra_Norm)
#   sdata %>% filter (!is.na(Ra_Norm) & !is.na(RS_Norm) & !is.na(Ecosystem_type)
#                     & Ecosystem_type != 'Forest') -> sdata
#   ggplot(data = sdata, aes(Ra_Norm, RS_Norm)) + geom_point() + facet_wrap(~Ecosystem_type)
# }

# Ra_Rs_relationship(DGRsD)

```


* 1. Introduction

** Figure. Sites distribution -- FlFsFr sites and RC/HC sites
```{r}
# plot sites distribution 
plot_sites(srdb_v4, FlFsFr)
```


```{r}
# Get Froot and Fshoot information from FlFsFr dataset and srdb_v4, see cal_Froot() in functions for more information
Froot <- cal_Froot(FlFsFr, srdb_v4) 
# check whether Froot + Fshoot = 1
Froot %>% transmute (check = Froot + Fshoot) %>% max
Froot %>% transmute (check = Froot + Fshoot) %>% min
Froot %>% group_by(Ecosystem) %>% summarise(count = n())
mean(Froot$Froot)
```

** Plot Froot by ecosystem type
```{r}
# potential issue: only two points from grassland
# no point from tundra 
# BBL: difficult to see what's going on here; really needs more comments!

plot_froot <- function (sdata) {
  var_obs <- nrow(sdata)
  # plot Froot (root respiration/aototrophic respiration ratio) by ecosystem type
  Fl_plot <- ggplot(sdata, aes(x = Ecosystem, y=Froot)) + geom_violin() +
    geom_jitter(shape=16, position=position_jitter(0.2), col = "gray") +
    geom_boxplot(width=.1) +
    ylab("Froot") +
    # stat_summary(fun.y=median, geom="point", size=2, color="red") +
    scale_x_discrete(limits = c("Agriculture", "Forest", "Grassland", "Savanna", "Wetland"),
                     labels = c("Agriculture (n=4)", "Forest (n=111)", "Grassland (n=2)", "Savanna (n=2)", "Wetland (n=3)") ) +
    theme(axis.title.x=element_blank())
  
  print(Fl_plot)
}

plot_froot (Froot)
```


```{r}
# Each row get the closese latitude and longitude values to AGB and SOC data
AGB$Latitude[which.min(abs(61.85 - AGB$Latitude))]
Froot %>% mutate(Latitude = round(Latitude*2, 0)/2 - 0.25, Longitude = round(Longitude*2, 0)/2-0.25) -> Froot
# there are no clear relationship between Froot and above-ground biomass or soil organic carbon (SOC)
left_join(Froot, AGB) %>% ggplot() + aes(RASTERVALU, Froot) + geom_point()
left_join(Froot, SOC) %>% ggplot() + aes(RASTERVALU, Froot) + geom_point()

```

** Plot global Rs, NPP, Fire-burned Carbon, and RC by ecosystem (root respiration to soil respiration ratio)
```{r, fig.height=6, fig.width=8}
# more details please see function plot_Rs()
plot_Rs (GlobalRs, srdb_v4, NPP) 
```


```{r}
# Bottom-up approache to stimate GPP
# Rroot = Rs * RC (Rroot to Rs ratio, from srdb)
# Froot = Rroot / Ra (root autotrophic respiration to total autotrophic respiration fraction/ratio, calculation please see plot_froot function)
# Fshoot = 1-Froot
# FsFr = (1-Froot)/Froot (FsFr = Rshoot/Rroot ratio)
# Ra = Rroot + Rshoot
# GPP = NPP + Rroot + Rshoot

# get subset data for Bottom-up approache to estimate GPP
var_RC <- srdb_v4 %>% select(RC_annual, Ecosystem_type) %>% filter(RC_annual > 0.01 & RC_annual < 0.99 & !is.na(RC_annual)) # dataset contain RC records
var_agr <- var_RC %>% filter (Ecosystem_type == "Agriculture") # dataset contain RC records only for agriculture ecosystem
var_des <- var_RC %>% filter (Ecosystem_type == "Desert") # dataset contain RC records only for desert
var_for <- var_RC %>% filter (Ecosystem_type == "Forest") # dataset contain RC records only for Forest ecosystem
var_gra <- var_RC %>% filter (Ecosystem_type == "Grassland") # dataset contain RC records only for grassland ecosystem
var_sav <- var_RC %>% filter (Ecosystem_type == "Savanna") # dataset contain RC records only for savanna ecosystem
var_shr <- var_RC %>% filter (Ecosystem_type == "Shrubland") # dataset contain RC records only for shrubland ecosystem
var_wet <- var_RC %>% filter (Ecosystem_type == "Wetland") # dataset contain RC records only for wetland ecosystem
# var_rest <- var_RC %>% filter (Ecosystem_type != "Forest") # dataset contain RC records for non-forest ecosystem
var_Rs <- GlobalRs %>% filter(!is.na(Rs) & is.na(SD) ) # dataset contain global Rs estimates (without standard diviation information)

n_samp <- 50000 # take 50000 samples
# n_rep <- 50000 

set.seed(1234567)
gpp_results <- tibble(
  # Rs = replicate( n_rep, sample(var_Rs$Rs, n_samp, replace = TRUE) %>% mean() ),
  # Rs1 = rnorm(n = n_samp, mean = 68, sd = 4),
  Rs1 = sample(var_Rs$Rs, n_samp, replace = TRUE), # randomly take a sample from global Rs estimates, with replace=TRUE, repeat 50000 times
  Rs2 = rnorm(n = n_samp, mean = 80.4, sd = 16.9), # for those with standard diviation, 50000 samples were take from normal distribution ~ (mean=80.4, sd=16.9)
  # repeat until all Rs estimates with sd samples were taken and hold in the outputs
  Rs3 = rnorm(n = n_samp, mean = 98, sd = 12), # same as above
  Rs4 = rnorm(n = n_samp, mean = 79, sd = 7.65), # same as above
  Rs5 = rnorm(n = n_samp, mean = 94.4, sd = 4.59), # same as above
  Rs6 = rnorm(n = n_samp, mean = 91, sd = 2.05), # same as above
  Rs7 = rnorm(n = n_samp, mean = 94.3, sd = 9.13), # same as above
  Rs8 = rnorm(n = n_samp, mean = 78.34, sd = 2.25), # same as above
  Rs9 = rnorm(n = n_samp, mean = 72.55, sd = 7.13), # same as above
  # Rs was calculated as the mean of above 9 Rs estimates
  Rs = (Rs1 + Rs2 + Rs3 + Rs4 + Rs5 + Rs6 + Rs7 + Rs8 + Rs9)/9,
  
  # Rc = replicate( n_rep, var_RC$RC_annual, n_samp, replace = TRUE) %>% mean() ), # senario 0: Rc not seperate into different ecosystems, not used
  # Senario 1: Rc seperate into 7 groups
  Rc_agr = sample(var_agr$RC_annual, n_samp, replace = TRUE) , # randomly take a sample from RC estimates for agriculture, repeat 50000 times
  Rc_des = sample(var_des$RC_annual, n_samp, replace = TRUE) , # randomly take a sample from RC estimates for desert, repeat 50000 times
  Rc_for = sample(var_for$RC_annual, n_samp, replace = TRUE) , # randomly take a sample from RC estimates for forest, repeat 50000 times
  Rc_gra = sample(var_gra$RC_annual, n_samp, replace = TRUE) , # randomly take a sample from RC estimates for grassland, repeat 50000 times
  Rc_sav = sample(var_sav$RC_annual, n_samp, replace = TRUE) , # randomly take a sample from RC estimates for savanna, repeat 50000 times
  Rc_shr = sample(var_shr$RC_annual, n_samp, replace = TRUE) , # randomly take a sample from RC estimates for shrubland, repeat 50000 times
  Rc_wet = sample(var_wet$RC_annual, n_samp, replace = TRUE) , # randomly take a sample from RC estimates for wetland, repeat 50000 times
  # calculation: Rc as a average of 7 ecosystem types, weighted by there area
  Rc = (Rc_agr*0.191 + Rc_des*0.17 + Rc_for*0.214 + Rc_gra*0.153 + Rc_sav*0.155 + Rc_shr*0.113 + Rc_wet*0.004), 
  # Senario 2: Rc seperate into 4 groups: agriculture, forest, grassland, and rest (all other ecosystems with obs<40, take samples from all RC records)
  Rc_rest = sample(var_RC$RC_annual, n_samp, replace = TRUE) , # randomly take a sample from all RC estimates, repeat 50000 times
  # only seperate into four groups, agriculture, forest, grassland and the rest
  Rc2 = (Rc_agr*0.191 + Rc_for*0.214 + Rc_gra*0.153 + Rc_rest*0.442), 
    
  # Froot = sample(Froot$Froot, n_samp, replace = TRUE), # senario 0: Froot not seperate into different ecosystems, not used
  Froot_agr = sample(Froot[Froot$Ecosystem == "Agriculture",]$Froot, n_samp, replace = TRUE), # take 50000 samples of Froot for agriculture 
  Froot_for = sample(Froot[Froot$Ecosystem == "Forest",]$Froot, n_samp, replace = TRUE), # take 50000 samples of Froot for forest 
  Froot_gra = sample(Froot[Froot$Ecosystem == "Grassland",]$Froot, n_samp, replace = TRUE), # take 50000 samples of Froot for grassland 
  Froot_sav = sample(Froot[Froot$Ecosystem == "Savanna",]$Froot, n_samp, replace = TRUE), # take 50000 samples of Froot for savanna 
  Froot_wet = sample(Froot[Froot$Ecosystem == "Wetland",]$Froot, n_samp, replace = TRUE), # take 50000 samples of Froot for agriculture 
  # take 50000 samples of Froot from all Froot recods, for senario2, those ecosystems have less than 40 obs use value from all Froot records
  Froot_rest = sample(Froot$Froot, n_samp, replace = TRUE), 
  
  # senario1: Froot calculate from 5 ecosystems, weighted by area
  Froot = Froot_agr*0.267 + Froot_for*0.298 + Froot_gra*0.213 + Froot_sav*0.216 + Froot_wet*0.006,
  # Senario 2: seperate into 2 ecosystems and weighted by area
  Froot2 = Froot_rest * 0.702 + Froot_for*0.298,
  FsFr = (1 - Froot) / Froot, # calculate Froot to Fshoot ratio of senario 1
  FsFr2 = (1 - Froot2) / Froot2, # calculate Froot to Fshoot ratio of senario 2
  NPP = sample(NPP$NPP, n_samp, replace = TRUE) , # take 500000 samples from NPP records
  
  gpp1 = rnorm(n = n_samp, mean = 124.6, sd = 2.7), # if gpp have mean and standard diviation, take 50000 samples from the normal distribution
  gpp2 = rnorm(n = n_samp, mean = 135.7, sd = 21.712), # same as above
  gpp3 = rnorm(n = n_samp, mean = 109.29, sd = 27.33), # same as above
  gpp4 = rnorm(n = n_samp, mean = 118, sd = 26), # same as above
  gpp5 = rnorm(n = n_samp, mean = 119, sd = 6), # same as above
  gpp6 = rnorm(n = n_samp, mean = 110.5, sd = 21.3), # same as above
  gpp7 = rnorm(n = n_samp, mean = 117, sd = 13), # same as above
  gpp8 = sample(GPP[is.na(GPP$SD),]$GPP, n_samp, replace = TRUE), # for those do not have SD information, take 50000 samples using boosting 
  GPP_raw =  (gpp1 + gpp2 + gpp3 + gpp4 + gpp5 + gpp6 + gpp7 + gpp8) / 8, # scenario 1: calculate 
  
  # Bottom up estimate of GPP, senario 1
  Rroot = Rs * Rc, # calculate root respiration
  Rshoot = Rroot * FsFr, # calculate shoot respiration
  
  # Bottom up estimate of GPP, senario 2
  Rroot2 = Rs * Rc2,
  Rshoot2 = Rroot2 * FsFr2,
  
  GPP = NPP + Rroot + Rshoot, # scenario 1: calculate GPP
  GPP2 = NPP + Rroot2 + Rshoot2 # scenario 2: calculate GPP
)

```



```{r}
# check
gpp_results %>% mutate(check = (1 - Froot) / Froot, FsFr)
```



```{r}
# hist(gpp_results$GPP) + abline (v = quantile (gpp_results$GPP, c(0.025, 0.5, 0.975)), col = "red", lty = "dashed")
# mean(gpp_results$GPP)
# max(gpp_results$GPP)

# senario 1
var_CI <- quantile(gpp_results$GPP, c(0.025, 0.5, 0.975)) %>% round(0)
var_CI_raw <- quantile(gpp_results$GPP_raw, c(0.025, 0.5, 0.975)) %>% round(0)
ggplot(gpp_results) + aes(GPP) + geom_histogram(col = "black", fill = "gray", bins = 30) + 
  geom_histogram(aes(GPP_raw), col = "blue", fill = "blue", bins = 30, alpha = 0.35) +
  geom_vline(xintercept = c(quantile (gpp_results$GPP_raw, c(0.025, 0.5, 0.975))),col = "red", linetype = "dotted", size = 1.5) +
  annotate("text", x = quantile(gpp_results$GPP, 0.98), y = 9000, label = paste0("95%CI (", var_CI[1],", ", var_CI[2], ", ", var_CI[3], ")"), hjust = 0) +
  annotate("text", x = quantile(gpp_results$GPP, 0.98), y = 7000, label = paste0("95%CI (", var_CI_raw[1],", ", var_CI_raw[2], ", ", var_CI_raw[3], ")")
           , hjust = 0, col = "blue") +
  xlab(expression(GPP~"("~Pg~C~yr^{-1}~")"))

# senario 2, RC seperate into 4 groups, and Froot seperate into 2 groups
var_CI <- quantile(gpp_results$GPP2, c(0.025, 0.5, 0.975)) %>% round(0)
var_CI_raw <- quantile(gpp_results$GPP_raw, c(0.025, 0.5, 0.975)) %>% round(0)
ggplot(gpp_results) + aes(GPP2) + geom_histogram(col = "black", fill = "gray", bins = 30) + 
  geom_histogram(aes(GPP_raw), col = "blue", fill = "blue", bins = 30, alpha = 0.35) +
  geom_vline(xintercept = c(quantile (gpp_results$GPP_raw, c(0.025, 0.5, 0.975))),col = "red", linetype = "dotted", size = 1.5) +
  annotate("text", x = quantile(gpp_results$GPP2, 0.98), y = 9000, label = paste0("95%CI (", var_CI[1],", ", var_CI[2], ", ", var_CI[3], ")"), hjust = 0) +
  annotate("text", x = quantile(gpp_results$GPP2, 0.98), y = 7000, label = paste0("95%CI (", var_CI_raw[1],", ", var_CI_raw[2], ", ", var_CI_raw[3], ")")
           , hjust = 0, col = "blue") +
  xlab(expression(GPP~"("~Pg~C~yr^{-1}~")"))


# GPP ~ NPP
ggplot(gpp_results) +
  aes(x = NPP, y = GPP) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") + 
  xlab(expression(NPP~"("~Pg~C~yr^{-1}~")")) +
  ylab(expression(GPP~"("~Pg~C~yr^{-1}~")"))

# GPP ~ Rs
ggplot(gpp_results) +
  aes(x = Rs, y = GPP) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression(R[S]~"("~Pg~C~yr^{-1}~")")) +
  ylab(expression(GPP~"("~Pg~C~yr^{-1}~")"))

# GPP ~ Rc
ggplot(gpp_results) +
  aes(x = Rc, y = GPP) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression(RC)) +
  ylab(expression(GPP~"("~Pg~C~yr^{-1}~")"))

# GPP ~ Froot
ggplot(gpp_results) +
  aes(x = Froot, y = GPP) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression(Froot)) +
  ylab(expression(GPP~"("~Pg~C~yr^{-1}~")"))

# GPP ~ Fshoot
ggplot(gpp_results) +
  aes(x = 1-Froot, y = GPP) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression(Fshoot)) +
  ylab(expression(GPP~"("~Pg~C~yr^{-1}~")"))
```

```{r}
# Quantify the probability GPP following (107, 133)
# about 29% chance GPP will between (107-133)
y <- mean(gpp_results$GPP)
s <- sd(gpp_results$GPP)
# accume GPP following normal distribution, with mean = y and sd = s, we can calculate the properbility of GPP following (107-133) 95%CI
p_gpp_less_than_133 <- pnorm ((133 - y) / (s))
p_gpp_less_than_107 <- pnorm ((107 - y) / (s))
p_gpp <- p_gpp_less_than_133 -p_gpp_less_than_107
p_gpp
# pnorm (-0.329)

# senario 2 looks like a little bit right tail skew
# about 18%
y <- mean(gpp_results$GPP2)
s <- sd(gpp_results$GPP2)
p_gpp_less_than_133 <- pnorm ((133 - y) / (s))
p_gpp_less_than_107 <- pnorm ((107 - y) / (s))
p_gpp <- p_gpp_less_than_133 -p_gpp_less_than_107
p_gpp
```


** GPP plot
```{r, fig.height = 3, fig.width = 8}
# panel (a). all 65 GPP estimates
# panel (b). GPP vs year, the red dots in panel c are calculated trend from panel b (increase rate = 0.2 if outliers removed, increase rate = 0.42 if outlers kept)
# panel (c). 16 GPP estimates reported GPP increase trend
plot_GPP(GPP)
```


** Plot Ra to GPP ratio
```{r}
# only one point from tundra
var_RaGpp <- plot_RaGPP (RaGPP, srdb_v4)
var_RaGpp %>% group_by (Ecosystem) %>% summarise ( count = n() ) %>% mutate (percent = count/sum(count)) %>%  arrange (desc(Ecosystem))
```



```{r}
# topdowm approach to eatimate Rs
# Ra = GPP * Ra_GPP_ratio (calculated based on data from a summary paper and from srdb, see plot_RaGPP function)
# Ra = GPP - NPP (two approaches yield a very similar results, we thus used the average of two estimates)

var_Fire <- c(2, 3.5, 7.3, 4, 5.1, 2.02, 2.71, 3.02, 2.08)
n_samp <- 50000

set.seed(1234567)
rs_results <- tibble(
  # GPP = replicate(n_rep, sample(GPP$GPP, n_samp, replace = TRUE) %>% mean() ),
  # GPP = sample(GPP$GPP, n_samp, replace = TRUE),
  gpp1 = rnorm(n = n_samp, mean = 124.6, sd = 2.7),
  gpp2 = rnorm(n = n_samp, mean = 135.7, sd = 21.712),
  gpp3 = rnorm(n = n_samp, mean = 109.29, sd = 27.33),
  gpp4 = rnorm(n = n_samp, mean = 118, sd = 26),
  gpp5 = rnorm(n = n_samp, mean = 119, sd = 6),
  gpp6 = rnorm(n = n_samp, mean = 110.5, sd = 21.3),
  gpp7 = rnorm(n = n_samp, mean = 117, sd = 13),
  gpp8 = sample(GPP[is.na(GPP$SD),]$GPP, n_samp, replace = TRUE),
  GPP =  (gpp1 + gpp2 + gpp3 + gpp4 + gpp5 + gpp6 + gpp7 + gpp8)/8,
  
  NPP = sample(NPP$NPP, n_samp, replace = TRUE),
  HerbComsum = rnorm(n = n_samp, mean = 2.2, sd = 0.2),
  Fire = sample(var_Fire, n_samp, replace = TRUE),
  sink = rnorm(n = n_samp, mean = 2.10, sd = 0.28),
  
  # RaGpp = sample(var_RaGpp$RaGPP_ratio, n_samp, replace = TRUE),
  RaGpp_agr = sample(var_RaGpp[var_RaGpp$Ecosystem == "Agriculture", ]$RaGPP_ratio, n_samp, replace = TRUE),
  RaGpp_for = sample(var_RaGpp[var_RaGpp$Ecosystem == "Forest", ]$RaGPP_ratio, n_samp, replace = TRUE),
  RaGpp_gra = sample(var_RaGpp[var_RaGpp$Ecosystem == "Grassland", ]$RaGPP_ratio, n_samp, replace = TRUE),
  RaGpp_sav = sample(var_RaGpp[var_RaGpp$Ecosystem == "Savanna", ]$RaGPP_ratio, n_samp, replace = TRUE),
  RaGpp_wet = sample(var_RaGpp[var_RaGpp$Ecosystem == "Wetland", ]$RaGPP_ratio, n_samp, replace = TRUE),
  RaGpp_rest = sample(var_RaGpp$RaGPP_ratio, n_samp, replace = TRUE),
  
  # senario 1
  RaGpp = RaGpp_agr*0.267 + RaGpp_for*0.298 + RaGpp_gra*0.213 + RaGpp_sav*0.216 + RaGpp_wet*0.006,
  # senario 2
  RaGpp2 = RaGpp_for*0.298 + RaGpp_rest*(1-0.298),
  
  # Froot = sample(Froot$Froot, n_samp, replace = TRUE), # senario 0: Froot not seperate into different ecosystems, not used
  Froot_agr = sample(Froot[Froot$Ecosystem == "Agriculture",]$Froot, n_samp, replace = TRUE),
  Froot_for = sample(Froot[Froot$Ecosystem == "Forest",]$Froot, n_samp, replace = TRUE),
  Froot_gra = sample(Froot[Froot$Ecosystem == "Grassland",]$Froot, n_samp, replace = TRUE),
  Froot_sav = sample(Froot[Froot$Ecosystem == "Savanna",]$Froot, n_samp, replace = TRUE),
  Froot_wet = sample(Froot[Froot$Ecosystem == "Wetland",]$Froot, n_samp, replace = TRUE),
  Froot_rest = sample(Froot$Froot, n_samp, replace = TRUE),
  Froot = Froot_agr*0.267 + Froot_for*0.298 + Froot_gra*0.213 + Froot_sav*0.216 + Froot_wet*0.006,
  # seperate into 2 groupts
  Froot2 = Froot_rest * 0.702 + Froot_for*0.298,
  
  # Rs_raw = sample(na.omit(GlobalRs$Rs), n_samp, replace = TRUE) ,
  Rs2 = rnorm(n = n_samp, mean = 80.4, sd = 16.9),
  Rs3 = rnorm(n = n_samp, mean = 98, sd = 12),
  Rs4 = rnorm(n = n_samp, mean = 79, sd = 7.65),
  Rs5 = rnorm(n = n_samp, mean = 94.4, sd = 4.59),
  Rs6 = rnorm(n = n_samp, mean = 91, sd = 2.05),
  Rs7 = rnorm(n = n_samp, mean = 94.3, sd = 9.13),
  Rs8 = rnorm(n = n_samp, mean = 78.34, sd = 2.25),
  Rs9 = rnorm(n = n_samp, mean = 72.55, sd = 7.13),
  Rs10 = sample(var_Rs$Rs, n_samp, replace = TRUE),
  Rs_raw = (Rs2 + Rs3 + Rs4 + Rs5 + Rs6 + Rs7 + Rs8 + Rs9 + Rs10)/9,
  
  Ra1 = GPP * RaGpp, # first way to calculate Ra, Ra = GPP * RaGPP
  Ra2 = GPP - NPP, # second way to calculate Ra, Ra = GPP - NPP
  # BBL: what's this comma? Why doesn't it cause an error?
  # response: because few Ra2 < 0 (when GPP < NPP), for those estimates, just drop them? or use Ra1 replace them? or keep them?
  Ra3 = ifelse(Ra2 < 0, Ra1, Ra2), 
  Ra_avg1 = (Ra1 + Ra3) / 2,
  
  Rroot = Ra_avg1 * Froot,
  Rshoot = Ra_avg1 * (1 - Froot),
  Rs_topdown = NPP - HerbComsum - Fire - sink + Rroot, 
  
  # senario2
  Ra4 = GPP * RaGpp2, # first way to calculate Ra, Ra = GPP * RaGPP
  Ra_avg2 = (Ra4 + Ra3) / 2,
  Rroot2 = Ra_avg2 * Froot2,
  Rshoot2 = Ra_avg2 * (1 - Froot2),
  Rs_topdown2 = NPP - HerbComsum - Fire - sink + Rroot2, 
  
)
```



```{r}
rs_results$Ra2 %>% min(na.rm = TRUE)
rs_results$Ra3 %>% min(na.rm = TRUE)
```


### Topdow approach results diagnose
```{r}
# mean(rs_results$Rs)
# max(rs_results$Rs)

var_CI <- quantile(rs_results$Rs_topdown, c(0.025, 0.5, 0.975)) %>% round(0)
var_CI_raw <- quantile(rs_results$Rs_raw, c(0.025, 0.5, 0.975)) %>% round(0)
ggplot(rs_results) + aes(Rs_topdown) + geom_histogram(col = "black", fill = "gray", bins = 30) + 
  geom_histogram(aes(Rs_raw), col = "blue", fill = "blue", bins = 30, alpha = 0.35) +
  geom_vline(xintercept = c(quantile (rs_results$Rs_raw, c(0.025, 0.5, 0.975))),col = "red", linetype = "dotted", size = 1.5) +
  annotate("text", x = quantile(rs_results$Rs_topdown, 0.98), y = 7000, label = paste0("95%CI (", var_CI[1],", ", var_CI[2], ", ", var_CI[3], ")"), hjust = 0) +
  annotate("text", x = quantile(rs_results$Rs_topdown, 0.98), y = 4000, label = paste0("95%CI (", var_CI_raw[1],", ", var_CI_raw[2], ", ", var_CI_raw[3], ")")
           , hjust = 0, col = "blue") +
  ylab(expression(count))

# senario two
var_CI <- quantile(rs_results$Rs_topdown2, c(0.025, 0.5, 0.975)) %>% round(0)
var_CI_raw <- quantile(rs_results$Rs_raw, c(0.025, 0.5, 0.975)) %>% round(0)
ggplot(rs_results) + aes(Rs_topdown2) + geom_histogram(col = "black", fill = "gray", bins = 30) + 
  geom_histogram(aes(Rs_raw), col = "blue", fill = "blue", bins = 30, alpha = 0.35) +
  geom_vline(xintercept = c(quantile (rs_results$Rs_raw, c(0.025, 0.5, 0.975))),col = "red", linetype = "dotted", size = 1.5) +
  annotate("text", x = quantile(rs_results$Rs_topdown2, 0.98), y = 7000, label = paste0("95%CI (", var_CI[1],", ", var_CI[2], ", ", var_CI[3], ")"), hjust = 0) +
  annotate("text", x = quantile(rs_results$Rs_topdown2, 0.98), y = 4000, label = paste0("95%CI (", var_CI_raw[1],", ", var_CI_raw[2], ", ", var_CI_raw[3], ")")
           , hjust = 0, col = "blue") +
  ylab(expression(count))

# Rs raw data plot
# var_CI <- quantile(rs_results$Rs_raw, c(0.025, 0.5, 0.975)) %>% round(0)
# plot_rs_raw <- ggplot(rs_results) + aes(Rs_raw) + geom_histogram(col = "black", fill = "gray", bins = 30) + 
#   geom_vline(xintercept = c(quantile (rs_results$Rs, c(0.025, 0.5, 0.975))),col = "red", linetype = "dotted", size = 1.5) +
#   annotate("text", x = quantile(rs_results$Rs, 0.98), y = 5000, label = paste0("95%CI (", var_CI[1],", ", var_CI[2], ", ", var_CI[3], ")"), hjust = 0)

# Ra1 ~ Ra2
ggplot(rs_results) +
  aes(x = Ra1) + geom_histogram(col = "black", fill = "gray", bins = 30) +
  geom_histogram(aes(Ra3), col = "blue", fill = "skyblue", bins = 30, alpha = 0.5) +
  xlab(expression(Ra1~or~Ra3~"("~Pg~C~yr^{-1}~")")) +
  ylab(expression(count))

# Rs ~ GPP
ggplot(rs_results) +
  aes(x = GPP, y = Rs_topdown) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression(GPP~"("~Pg~C~yr^{-1}~")")) +
  ylab(expression(R[S]~"("~Pg~C~yr^{-1}~")"))

# Rs ~ NPP
ggplot(rs_results) +
  aes(x = NPP, y = Rs_topdown) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression(NPP~"("~Pg~C~yr^{-1}~")")) +
  ylab(expression(R[S]~"("~Pg~C~yr^{-1}~")"))

# Rs ~ RaGpp
ggplot(rs_results) +
  aes(x = RaGpp, y = Rs_topdown) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression("Ra/GPP"~"("~Pg~C~yr^{-1}~")")) +
  ylab(expression(R[S]~"("~Pg~C~yr^{-1}~")"))

# Rs ~ Froot
ggplot(rs_results) +
  aes(x = Froot, y = Rs_topdown) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression(Froot)) +
  ylab(expression(R[S]~"("~Pg~C~yr^{-1}~")"))

# Rs ~ Fire
ggplot(rs_results) +
  aes(x = Fire, y = Rs_topdown) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression(Fire~burned~"("~Pg~C~yr^{-1}~")")) +
  ylab(expression(R[S]~"("~Pg~C~yr^{-1}~")"))
```

```{r}
# accume Rs following normal distribution, with mean = y and sd = s, we can calculate the properbility of Rs following (80-92) 95%CI
# about 28% chance Rs will be between (80-92)
y <- mean(rs_results$Rs_topdown)
s <- sd(rs_results$Rs_topdown)
p_Rs_higher_than_80 <- pnorm ((y - 80)/(s))
p_Rs_higher_than_92 <- pnorm ((y - 92)/(s))
p_Rs <- p_Rs_higher_than_80 -p_Rs_higher_than_92
p_Rs

# Senario 2: about 23% chance Rs will be between (80-92)
y <- mean(rs_results$Rs_topdown2)
s <- sd(rs_results$Rs_topdown2)
p_Rs_higher_than_80 <- pnorm ((y - 80)/(s))
p_Rs_higher_than_92 <- pnorm ((y - 92)/(s))
p_Rs <- p_Rs_higher_than_80 -p_Rs_higher_than_92
p_Rs
```

