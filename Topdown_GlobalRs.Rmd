---
title: "GlobalC"
author: "Jinshi"
date: "May 19, 2019"
output:
  html_document: default
  word_document: default
---

## summary

## Abbreviations
* Rroot - root respiration
* Rshoot - shoot respiration
* Rs - soil respiration
* RSG - global annual soil respiration 
* Ra - autotrophic respiration (Rroot + Rshoot)
* GPP - gross primary production
* NPP - net primary production
* NEP - net ecosystem production

* Froot - Rroot / Ra (root autotrophic respiration to total autotrophic respiration fraction/ratio, calculation please see plot_Rroot_Ra_ratio function)
* Fshoot - Rshoot / Ra (1-Froot)
* FsFr - (1-Froot)/Froot (FsFr = Rshoot/Rroot ratio)
* RC - (root respiration / soil respiration)
* RaGPP - (Ra/GPP) ratio


## Assumptions
* __Bottom-up approach:__ 
1. We collected published global soil respiration estimates (mostly is based on bottom up field Rs measurements)
2. We then partition Rs into root respiration and belowground heterotrophic resipiration
3. We also collected published NPP estimates from ITO et al. (2011)
4. From published Rroot/Ra ratios, GPP can be calculated as (NPP + Rroot + Rshoot)
5. We then compare this bottom-up GPP with published GPP in the past decades

* __Top-down approach:__
6. We first collect global GPP estimates (most are top-down from remote sensing)
7. We then estimate Ra according to published Ra/GPP ratios and GPP-NPP
8. Heterotrophic respiration was estimated as Rh = NPP - HerbComsum - Fire - Csink (NEP)
9. Rs_topdown =  Rh + Rroot
10. We then compare this with published Rs (#1 above)

## Questions and more analysis in the future
* How unlikely is it that we can reconcile current Rs and GPP estimates? 
E.g. what % of the distribution of each 'allows' us to match the central estimate of the other? (<30%)
* What is driving the differences between botton-up GPP and reported GPP and top-down Rs and reported Rs?
* How do we resolve this? Where is better/more data needed? 
* These questions all resolve around influence x uncertainty = importance, right? This is basically the 'Dietze graph'.
* Savanna and grassland more than 20% area, but sample numbers are too small for Frrot, RC, and Ra/Gpp ratio
* Ra < 0 how to resolve this (resolved)

## Importance/implication/benefits
* Provide another way to estimate GPP and Rs
* Provide a method to compare bottom-up GPP (start from field Rs/Froot/RC/Rroot measurements, then modelling to estimate GPP) with remote sensing or land model GPP.
* Provide a method to compare top-down Rs (Rs separated from remote sensing land model based GPP) with filed experiment based Rs (field Rs measurement, then modeling).


```{r preliminaries, message=FALSE, echo=FALSE}
# Constants
OUTPUT_DIR		<- "outputs/"
DATA_DIR <- 'data'
# Create output and log folders if they do not exist
if(!file.exists(OUTPUT_DIR)) dir.create(OUTPUT_DIR)

library(kableExtra)
# Load required packages
library(data.table)
library(lubridate)
library(knitr)
library(ggpubr)

library(ggplot2)
theme_set(theme_bw())
library(cowplot)
library(ggmap)
library(maps)
library(mapdata)
# install.packages("ggExtra")
library(ggExtra)

library(tidyr)
library(hexbin)
library(dplyr)

# install.packages('ggbeeswarm')
library(ggbeeswarm)

# Source all needed functions
source('functions.R')

# Set chunks defaults; these options will be applied to all subsequent chunks
knitr::opts_chunk$set(results = 'hide', message = TRUE, include = TRUE, 
                      echo = FALSE, warning = FALSE,
                      fig.height = 4, fig.width = 8, cache = F)

```


## Methods

```{r load data}
# input data
read_file <- function(x) read.csv(file.path(DATA_DIR, x), stringsAsFactors = FALSE)

srdb_v4 <- read_file('srdbv4.csv') # SRDB_V4 data
FlFsFr <- read_file('FlFsFrSummary.csv') # Froot (Rroot/Rs) and Fshoot (Rshoot/Rs) from 39 papers
GPP <- read_file('GlobalGPP_Sum.csv') # GPP estimates from published paper
GPP %>% filter(Pub_year > 1980 & Flag != "Model") -> GPP
NPP <- read_file('ITONPP.CSV') # 251 NPP estimates from ITO (2011)
GlobalRs <- read_file('GlobalRs.csv') # estimates of global Rs
GlobalRs %>% filter(Pub_year > 1980) -> GlobalRs
# (Ra/GPP) Piao, Shilong, et al. "Forest annual carbon cost: A global‐scale analysis of autotrophic respiration." Ecology 91.3 (2010): 652-661.
RaGPP <- read_file('RaGPP.csv') 
var_Fire <- read_file('Fire_burn_C.csv')

# IGBP data, and information to map it with other data
IGBP <- read_file('IGBP.txt') %>% 
  left_join(read_file("igbp_mapping.csv"), by = "IGBP2001Pr")

# DGRsD <- read_file('DGRsD.csv')
AGB <- read_file('GLC2000_Point.txt') %>% 
  filter(RASTERVALU != -9999)

SOC <- read_file('SOC_Point.txt')

srdb_v4 %>% 
  select(Study_number, Biome, Ecosystem_type, Leaf_habit, 
         Latitude, Longitude, RC_annual, Ra_annual, Rh_annual) %>% 
  filter(RC_annual > 0, RC_annual < 1) -> 
  sub_srdb

# calculate Froot
Froot <- cal_Froot(FlFsFr, srdb_v4) 
# check whether Froot + Fshoot = 1

Froot %>% mutate(IGBP2 = case_when( 
  IGBP %in% c('DBF', 'Deciduous') & Ecosystem == 'Forest' ~ "DF",
  IGBP %in% c('EBF', 'ENF', 'Evergreen') & Ecosystem == 'Forest' ~ "EF",
  IGBP %in% c('MF', 'Mixed') & Ecosystem == 'Forest' ~ "MF",
  TRUE ~ "Other"
)) -> Froot

```


```{r missing SD issue}
# GPP %>% select(GPP, SD) %>% filter (!is.na(SD)) %>% ggplot(aes(GPP, SD)) + geom_point()
# GPP %>% select(GPP, SD) %>% filter (!is.na(SD)) %>% lm(GPP, SD) %>% summary()

# GlobalRs %>% select(Rs, SD) %>% filter (!is.na(SD)) %>% ggplot(aes(Rs, SD)) + geom_point()
# GlobalRs %>% select(Rs, SD) %>% filter (!is.na(SD)) %>% lm(Rs, SD) %>% summary()
```



## Ratio by vegetation types {.tabset .tabset-fade .tabset-pills}
### Plot GPP
```{r plot GPP and RSG, fig.height = 6, fig.width = 8, cache=FALSE}
# Use ggbeeswarm to replot those figures, see https://github.com/eclarke/ggbeeswarm
# panel (a). all 65 GPP estimates
# panel (b). GPP vs year, the red dots in panel c are calculated trend from panel b (increasing rate = 0.2 if outliers removed, 0.42 if outliers kept)
# panel (c). 16 GPP estimates reported GPP increase trend
plot_GPP_RSG (GPP, GlobalRs)
ggsave("outputs/FigureS1.jpg", width = 8, height = 6, dpi = 300, units = "in")

# A couple of simpler figures for Ben's Japan presentation
p_gpp <- ggplot(GPP, aes(Year, GPP)) + geom_point() + 
  geom_errorbar(aes(ymin = GPP - SD, ymax = GPP + SD), na.rm = TRUE) + 
  geom_smooth(method = "lm") + theme_cowplot() +
  ylab(expression(GPP~(Pg~C~yr^-1)))
p_gpp_marg <- ggMarginal(p_gpp, type = "densigram", margins = "y", fill = "red")
ggsave("outputs/p_gpp.png", plot = p_gpp_marg, width = 8, height = 5)

p_rs <- ggplot(GlobalRs, aes(Pub_year, Rs)) + geom_point() + 
  geom_errorbar(aes(ymin = Rs - SD, ymax = Rs + SD), na.rm = TRUE) + 
  geom_smooth(method = "lm") + theme_cowplot() +
  xlab("Year") + ylab(expression(R[S]~(Pg~C~yr^-1)))
p_rs_marg <- ggMarginal(p_rs, type = "densigram", margins = "y", fill = "red")
ggsave("outputs/p_rs.png", plot = p_rs_marg, width = 8, height = 5)
```


### Plot Rroot-Rs ratio

```{r plot RC, fig.height=6, fig.width=8}
# Plot global Rs, NPP, Fire-burned Carbon, and RC by ecosystem (root respiration to soil respiration ratio)
# more details please see function plot_Rroot_Rs_NPP ()
# prepare data first
sub_srdb %>% count(Leaf_habit) 

sub_srdb %>% 
  mutate(IGBP2 = case_when(Ecosystem_type == "Agriculture" ~ "Agriculture",
                           Ecosystem_type == "Grassland" ~ "Grassland",
                           Ecosystem_type %in% c("Savanna", "Shrubland") ~ "Shrubland",
                           Ecosystem_type == "Forest" & Leaf_habit == 'Deciduous' ~ "DF",
                           Ecosystem_type == "Forest" & Leaf_habit == 'Evergreen' ~ "EF",
                           Ecosystem_type == "Forest" & Leaf_habit == 'Mixed' ~ "Mixed",
                           TRUE ~ "Other")) -> sub_srdb

sub_srdb %>% count(IGBP2) 

plot_Rroot_Rs_NPP (GlobalRs, sub_srdb, NPP) 
ggsave("outputs/FigureS2.jpg", width = 8, height = 6, dpi = 300, units = "in")
```

### Plot Rroot-Ra ratio
```{r plot Rroot-Ra ratio, fig.height = 4, fig.width = 6}
# potential issue: only two points from grassland
# no point from tundra 
plot_Rroot_Ra_ratio(Froot)
ggsave("outputs/FigureS3.jpg", width = 6, height = 4, dpi = 300, units = "in")
```

### Plot Ra to GPP ratio
```{r plot Ra-GPP ratio}
# only one point from tundra
var_RaGpp <- prep_RaGpp(RaGPP, srdb_v4)

var_RaGpp$Ecosystem <- ifelse(is.na(var_RaGpp$Ecosystem), var_RaGpp$Ecosystem_type, var_RaGpp$Ecosystem)
var_RaGpp %>% count(Leaf_habit)
var_RaGpp %>% count(Ecosystem)
var_RaGpp %>% count(Ecosystem_type)

var_RaGpp %>% 
  mutate(IGBP2 = case_when(
    Ecosystem %in% c("Crop", "Tundra", "Wetland", "Agriculture") ~ "Other",
    Ecosystem %in% c("Grassland", "Savanna") ~ "Grassland",
    Ecosystem == "Forest" & Leaf_habit == "Deciduous" ~ "Deciduous",
    Ecosystem == "Forest" & Leaf_habit == "Evergreen" ~ "Evergreen",
    Ecosystem == "Forest" & Leaf_habit == "Forest" ~ "Forest",
    Ecosystem == "Forest" & Leaf_habit == "Mixed" ~ "Forest",
    TRUE ~ "NOTA")
  ) -> var_RaGpp

var_RaGpp %>% count(Ecosystem)

plot_RaGPP(var_RaGpp)
ggsave("outputs/FigureS4.jpg", width = 6, height = 4, dpi = 300, units = "in")

var_RaGpp %>% count(IGBP2)

var_RaGpp %>% 
  group_by(Ecosystem) %>% 
  summarise(count = n()) %>%
  mutate(percent = count / sum(count)) %>%
  arrange(desc(Ecosystem))
```

## Sites spatial distribution
```{r plot spatial distribution, echo=FALSE, warning=FALSE}
# Figure. Sites distribution -- FlFsFr sites and RC/HC sites
plot_sites(srdb_v4, Froot, srdb_v4)
```



```{r calculate vegetation areas}
# IGBP area by type
IGBP %>% count(IGBP_group)
# Wrong old calculation
# IGBP %>% filter(IGBP_group != "WAT") %>% 
#   group_by(IGBP_group) %>% 
#   summarise(count = n()) %>% 
#   mutate(percent = count / sum(count)) -> IGBP_summary

# Updated calculation
IGBP %>% 
  filter(IGBP_group != "WAT") %>% 
  group_by(IGBP_group) %>% 
  summarise(rel_area = sum(cos(abs(Latitude) / 180 * pi))) %>% 
  mutate(percent = rel_area / sum(rel_area)) -> IGBP_summary

ag_area <- IGBP_summary[IGBP_summary$IGBP_group == "CRO",]$percent
df_area <- IGBP_summary[IGBP_summary$IGBP_group == "DF",]$percent
ef_area <- IGBP_summary[IGBP_summary$IGBP_group == "EF",]$percent
mf_area <- IGBP_summary[IGBP_summary$IGBP_group == "MF",]$percent
gra_area <- IGBP_summary[IGBP_summary$IGBP_group == "GRA",]$percent
shr_area <- IGBP_summary[IGBP_summary$IGBP_group == "SH",]$percent
```


```{r boostrapping-prep}
# 1. prepare RC (Rroot-to-Rs ratio data) **********
# get subset data for Bottom-up approach to estimate GPP, separate into 7 groups
var_RC <- sub_srdb %>% 
  select(RC_annual, Ecosystem_type, IGBP2) %>% 
  filter(RC_annual > 0.01, RC_annual < 0.99, !is.na(RC_annual)) # dataset contain RC records
var_for_rc <- var_RC %>% filter(Ecosystem_type == "Forest")
# forest further separate into 3 groups
var_df_rc <- var_RC %>% filter(IGBP2 == "DF")
var_ef_rc <- var_RC %>% filter(IGBP2 == "EF")
var_mf_rc <- var_RC %>% filter(IGBP2 == "Mixed")
var_agr_rc <- var_RC %>% filter(Ecosystem_type == "Agriculture")
var_gra_rc <- var_RC %>% filter(Ecosystem_type == "Grassland")
var_shr_rc <- var_RC %>% filter(Ecosystem_type %in% c("Shrubland", "Savanna"))
# Other groups
var_other_rc <- var_RC %>% filter(Ecosystem_type %in% c("Desert", "Wetland"))
var_rest_rc <- var_RC # for those ecosystem (e.g., tundra) with no data, use all from RC dataset

# 2. prepare Froot (Rroot-to-Ra ratio data) **********
var_agr_froot <- Froot[Froot$Ecosystem == "Agriculture",]$Froot # samples of Froot for agriculture
var_for_froot <- Froot[Froot$Ecosystem == "Forest",]$Froot #  forest
var_gra_froot <- Froot[Froot$Ecosystem == "Grassland",]$Froot #  grassland
var_sav_froot <- Froot[Froot$Ecosystem == "Savanna",]$Froot #  savanna
var_wet_froot <- Froot[Froot$Ecosystem == "Wetland",]$Froot 
var_rest_froot <- Froot$Froot # for those ecosystems with no data, use all data from Froot
# only separate into ef and the rest
var_ef_froot <- Froot[Froot$IGBP2 == "EF",]$Froot # Froot data for ef
var_df_froot <- Froot[Froot$IGBP2 == "DF",]$Froot # Froot data for df
var_mf_froot <- Froot[Froot$IGBP2 == "MF",]$Froot # Froot data for mf
var_other_froot <- Froot[Froot$IGBP2 == "Other",]$Froot # samples of Froot for non-forest
```


```{r bootstrap-creation}
# Bootstrap settings
RESAMPLE <- method3
RESAMPLE_noSD <- method1
N_SAMPLES <- 50000
sample_size <- 10
QUANTILES <- c(0.025, 0.5, 0.975)  # Generate mean and 95% CI
set.seed(20190827)

# Rs and GPP draws used by bootstrapping GPP and Rs blocks below
bootstrap_data <- tibble(Rs_raw = sapply(rep(sample_size, N_SAMPLES), RESAMPLE, GlobalRs$Rs, GlobalRs$SD),
                         GPP_raw = sapply(rep(sample_size, N_SAMPLES), RESAMPLE, GPP$GPP, GPP$SD))

sd(bootstrap_data$Rs_raw) # why sd so small, not as expected
sd(bootstrap_data$GPP_raw) # why sd so small, not as expected
```


## Bootstrapping GPP
```{r gpp-bootstrap}
# Bottom-up approach to estimate GPP
# Rroot = Rs * RC (Rroot to Rs ratio, from srdb)
# Froot = Rroot / Ra (root autotrophic respiration to total autotrophic respiration fraction/ratio, calculation please see plot_Rroot_Ra_ratio function)
# Fshoot = 1-Froot
# FsFr = (1-Froot)/Froot (FsFr = Rshoot/Rroot ratio)
# Ra = Rroot + Rshoot
# GPP = NPP + Rroot + Rshoot

bootstrap_data %>% 
  mutate(
    # Step 1. Prepare NPP, boosting from ITO paper
    NPP = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, NPP$NPP),
    
    # Step 2. sampling Rroot-to Rs ratio (RC)
    Rc_agr = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_agr_rc$RC_annual),
      
    # forest further separate into 3 groups
    Rc_df = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_df_rc$RC_annual),
    Rc_ef = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_ef_rc$RC_annual),
    Rc_mf = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_mf_rc$RC_annual), 
    # other ecosystems
    Rc_gra = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_gra_rc$RC_annual),
    Rc_shr = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_shr_rc$RC_annual),
    # for other ecosystems we use samples from all RC records
    Rc_rest = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_rest_rc$RC_annual), 
    
    # Step 3. Sampling Rroot-to-Ra ratio (Froot)
    Froot_df = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_df_froot),
    Froot_ef = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_ef_froot),
    Froot_mf = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_mf_froot),
    # for other ecosystems we use samples from all RC records
    Froot_rest = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_rest_froot),
    
    # Step 4. calculation ********************
    # Rc = replicate( n_rep, var_RC$RC_annual, N_SAMPLES, replace = TRUE) %>% mean() ), # scenario 0: Rc not separate into different ecosystems, not used
    Rc = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_RC$RC_annual),
    
    # Scenario 2: Rc separate into groups: agriculture, deciduous forest, grassland, etc 
    # all other ecosystems with obs<40, take samples from all RC records
    # area of rest ecosystem = 1-sum(agriculture, forest, grassland, etc)
    Rc2 = (Rc_agr * ag_area + Rc_df * df_area + Rc_ef * ef_area + Rc_mf * mf_area + 
             Rc_gra * gra_area + Rc_shr * shr_area + Rc_rest * 
             (1 - ag_area - df_area - ef_area-mf_area - gra_area - shr_area)), 
    
    # Scenario 1: Froot not separated into different ecosystems
    Froot = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, Froot$Froot),
    
    FsFr = (1 - Froot) / Froot, # calculate Froot to Fshoot ratio of scenario 1
    # Bottom up estimate of GPP, scenario 1
    Rroot = Rs_raw * Rc, # root respiration
    Rshoot = Rroot * FsFr, # shoot respiration
    
    # Scenario 2: separate into different ecosystems and weighted by area
    # Froot %>% count(Ecosystem)
    Froot2 = Froot_df * df_area + Froot_ef * ef_area + Froot_mf * mf_area + 
      Froot_rest * (1 - df_area - ef_area - mf_area),
    FsFr2 = (1 - Froot2) / Froot2, # Froot to Fshoot ratio of scenario 2
    # Bottom up estimate of GPP, scenario 2
    Rroot2 = Rs_raw * Rc2,
    Rshoot2 = Rroot2 * FsFr2,
    
    GPP = NPP + Rroot + Rshoot, # scenario 1: GPP
    GPP2 = NPP + Rroot2 + Rshoot2 # scenario 2: GPP2
  ) ->
  gpp_results
```


## GPP results {.tabset .tabset-fade .tabset-pills}
### Scenario 1 - ratio __not__ weighted by ecosystem
```{r plot GPP comparison, results='asis'}
# Scenario 1
gpp_qt <- quantile(gpp_results$GPP, QUANTILES) %>% round(0)
gpp_qt_raw <- quantile(gpp_results$GPP_raw, QUANTILES) %>% round(0)

gpp_results %>%
  select(`GPP implied by Rs` = GPP, `Top-down GPP` = GPP_raw) %>% 
  gather(GPP_type) ->
  gpp_figure_data

gpp_figure_data %>% 
  ggplot(aes(value, fill = GPP_type)) +
  theme_cowplot() +
  geom_density(stat = 'density', alpha = 0.5) +
  theme(legend.position = c(0.75, 0.35)) +
  coord_cartesian(xlim = c(70, 250)) +
  scale_fill_discrete("") + ylab("Density") +
  xlab(expression(GPP~(Pg~C~yr^{-1}))) ->
  gpp_base_figure

p_gpp <- p_gpp + theme(text = element_text(size = 9),
                       axis.text = element_text(size = 9))
p_gpp_marg <- ggMarginal(p_gpp, type = "densigram", margins = "y", fill = "red")

p1_gpp <- ggdraw() +
  draw_plot(gpp_base_figure) +
  draw_plot(p_gpp_marg, x = 0.6, y = 0.5, width = 0.4, height = 0.5)
print(p1_gpp)

cat("\n\nGPP implied by Rs quantiles: ", gpp_qt, "\n")
cat("\n\nTop-down GPP quantiles: ", gpp_qt_raw, "\n")
ggsave("outputs/Figure1_gpp.jpg", width = 8, height = 4, dpi = 300, units = "in")
```

### Scenario 2 - ratio __weighted__ by ecosystem
```{r, results='asis'}
# Scenario 2
gpp_qt <- quantile(gpp_results$GPP2, QUANTILES) %>% round(0)
gpp_qt_raw <- quantile(gpp_results$GPP_raw, QUANTILES) %>% round(0)

gpp_results %>%
  select(`GPP implied by Rs` = GPP2, `Top-down GPP` = GPP_raw) %>% 
  gather(GPP_type) ->
  gpp_figure2_data

p1_gpp2 <- ggdraw() +
  draw_plot(gpp_base_figure %+% gpp_figure2_data) +
  draw_plot(p_gpp_marg, x = 0.6, y = 0.5, width = 0.4, height = 0.5)
print(p1_gpp2)

cat("\n\nGPP implied by Rs quantiles: ", gpp_qt, "\n")
cat("\n\nTop-down GPP quantiles: ", gpp_qt_raw, "\n")
ggsave("outputs/Figure1_gpp_weighted.jpg", width = 8, height = 4, dpi = 300, units = "in")
```

### Scenario 3 - SRDB Rs:GPP ratios
```{r SRDB Rs:GPP ratios, results='asis'}
# Compute the median Rs:GPP ratio, weighted by ecosystem type globally
IGBP %>% 
  filter(IGBP_group != "WAT") %>% 
  group_by(Ecosystem_type = Ecosystem) %>% 
  summarise(rel_area = sum(cos(abs(Latitude) / 180 * pi))) -> 
  IGBP_summary_ecosystem

srdb_v4 %>% 
  filter(Ecosystem_state != "Managed") %>% 
  left_join(IGBP_summary_ecosystem, by = "Ecosystem_type") ->
  srdb_v4_ratio

Rs_to_GPP_unweighted <- with(srdb_v4, mean(Rs_annual / GPP, na.rm = TRUE))
Rs_to_GPP_weighted <- with(srdb_v4_ratio, weighted.mean(Rs_annual / GPP, 
                                                        w = rel_area, na.rm = TRUE))

bootstrap_data %>% 
  mutate(Rs = GPP_raw * Rs_to_GPP_weighted,
         GPP = Rs_raw / Rs_to_GPP_weighted) ->
  ratio_results

gpp_qt <- quantile(ratio_results$GPP, QUANTILES) %>% round(0)
gpp_qt_raw <- quantile(ratio_results$GPP_raw, QUANTILES) %>% round(0)

ratio_results %>%
  select(`GPP implied by SRDB Rs:GPP` = GPP, `Top-down GPP` = GPP_raw) %>% 
  gather(GPP_type) ->
  gpp_ratio_figure_data

p1_gpp3 <- ggdraw() +
  draw_plot(gpp_base_figure %+% gpp_ratio_figure_data) +
  draw_plot(p_gpp_marg, x = 0.6, y = 0.5, width = 0.4, height = 0.5) 
print(p1_gpp3)

cat("\n\nGPP implied by Rs quantiles: ", gpp_qt, "\n")
cat("\n\nTop-down GPP quantiles: ", gpp_qt_raw, "\n")
ggsave("outputs/Figure1_gpp_simple.jpg", width = 8, height = 4, dpi = 300, units = "in")
```


### GPP vs components relationships
```{r}
gpp_results %>% ggplot() + aes(Rc) + 
  # geom_histogram(col = "black", fill = "gray", bins = 30) + 
  geom_density(stat = 'density', col = "gray", fill = rgb(1, 0, 1, alpha = 0.5) )

gpp_results %>% ggplot() + aes(Rc2) + 
  # geom_histogram(col = "black", fill = "gray", bins = 30) + 
  geom_density(stat = 'density', col = "gray", fill = rgb(1, 0, 1, alpha = 0.5) )

gpp_results %>% ggplot() + aes(Rroot) + 
  # geom_histogram(col = "black", fill = "gray", bins = 30) + 
  geom_density(stat = 'density', col = "gray", fill = rgb(1, 0, 1, alpha = 0.5) )

gpp_results %>% ggplot() + aes(Rroot2) + 
  # geom_histogram(col = "black", fill = "gray", bins = 30) + 
  geom_density(stat = 'density', col = "gray", fill = rgb(1, 0, 1, alpha = 0.5) )

# GPP ~ NPP
ggplot(gpp_results, aes(NPP, GPP2)) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") + 
  xlab(expression(NPP~(Pg~C~yr^{-1}))) +
  ylab(expression(GPP~(Pg~C~yr^{-1})))

# GPP ~ Rs
ggplot(gpp_results, aes(Rs_raw, GPP2)) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression(R[S]~(Pg~C~yr^{-1}))) +
  ylab(expression(GPP~(Pg~C~yr^{-1})))

# GPP ~ Rc
ggplot(gpp_results, aes(Rc, GPP2)) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab("RC") +
  ylab(expression(GPP~(Pg~C~yr^{-1})))

# GPP ~ Froot
ggplot(gpp_results, aes(Froot, GPP2)) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  ylab(expression(GPP~(Pg~C~yr^{-1})))

# GPP ~ Fshoot
ggplot(gpp_results, aes(x = 1-Froot, y = GPP2)) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab("Fshoot") +
  ylab(expression(GPP~(Pg~C~yr^{-1})))
```

### Probability of agreement
```{r gpp-agreement, cache=FALSE}
p_gpp1 <- prob_agreement(gpp_results$GPP, gpp_qt_raw)
p_gpp2 <- prob_agreement(gpp_results$GPP2, gpp_qt_raw)
p_gpp3 <- prob_agreement(ratio_results$GPP, gpp_qt_raw)
p_gpp1_tt <- t_test(gpp_results$GPP_raw, gpp_results$GPP)
p_gpp2_tt <- t_test(gpp_results$GPP_raw, gpp_results$GPP2)
p_gpp3_tt <- t_test(gpp_results$GPP_raw, ratio_results$GPP)
```

Scenario                 | Agreement (quantiles) | p-value (t.test)
------------------------ | --------------------- | -----------------
1 (no weighting)         | `r p_gpp1 * 100` %     | `r p_gpp1_tt`
2 (weighting)            | `r p_gpp2 * 100` %     | `r p_gpp2_tt`
3 (global Rs:GPP)        | `r p_gpp3 * 100` %     | `r p_gpp3_tt`


```{r prepare variables for RSG boostrapping}
# Froot used the same data as bottom-up approach
# var_Fire <- c(2, 3.5, 7.3, 4, 5.1, 2.02, 2.71, 3.02, 2.08)
# prepare RaGPP ratio data
var_RaGpp %>% count(IGBP2)
var_RaGpp_df <- var_RaGpp %>% filter(IGBP2 == "Deciduous") %>% pull(RaGPP_ratio)
var_RaGpp_ef <- var_RaGpp %>% filter(IGBP2 == "Evergreen") %>% pull(RaGPP_ratio)
# mixed forest are from all forests due to lack of data
var_RaGpp_mf <- var_RaGpp %>% filter(IGBP2 == "Forest") %>% pull(RaGPP_ratio)
var_RaGpp_gra <- var_RaGpp %>% filter(IGBP2 == "Grassland") %>% pull(RaGPP_ratio)
```

## Bootstrapping RSG
```{r rs-bootstrap}
# topdown approach to estimate Rs
# Ra = GPP * Ra_GPP_ratio (calculated based on data from a 
#   summary paper and from srdb; see plot_RaGPP function)
# Ra = GPP - NPP (two approaches yield very similar results;
#   we thus used the average of two estimates)
bootstrap_data %>% 
  mutate(
    # Step 1. prepare other components, NPP and NPP consumed by fire etc.
    NPP = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, NPP$NPP),
    # Carbon comsumed by herbivor animnals (mean:2.2, SD: 0.2), from
    # Doughty, C. E. & Field, C. B. Agricultural net primary production in relation to that liberated by the extinction of Pleistocene mega-herbivores: 
    # an estimate of agricultural carrying capacity? Environ. Res. Lett. 5, 044001 (2010).
    HerbComsum = rnorm(n = N_SAMPLES, mean = 2.2, sd = 0.2),
    # Fire = sample(var_Fire$Amount_Pg, N_SAMPLES, replace = TRUE),
    Fire = sapply(rep(sample_size, N_SAMPLES), RESAMPLE, var_Fire$Amount_Pg, var_Fire$SD),
    # Carbon going to terrestrial as carbon sink (mean = 2.1, SD = 0.28), from
    # Le Quéré, C. et al. Global carbon budget 2015. Earth Syst. Sci. Data 7, 349–396 (2015).
    sink = rnorm(n = N_SAMPLES, mean = 2.10, sd = 0.28),
    
    # Step 2. Ra-to-GPP ratio boosting
    # RaGpp = sample(var_RaGpp$RaGPP_ratio, N_SAMPLES, replace = TRUE),
    RaGpp_df = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_RaGpp_df),
    RaGpp_ef = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_RaGpp_ef),
    RaGpp_mf = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_RaGpp_mf),
    RaGpp_gra = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_RaGpp_gra),
    # for other ecosystems, we use samples from all Froot
    RaGpp_rest = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_RaGpp$RaGPP_ratio),
    
    # Step 3. Sampling Rroot-to-Ra ratio (Froot)
    Froot_df = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_df_froot),
    Froot_ef = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_ef_froot),
    Froot_mf = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_mf_froot),
    Froot_gra = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_gra_froot),
    # for other ecosystems, we use samples from all Froot
    Froot_rest = sapply(rep(sample_size, N_SAMPLES), RESAMPLE_noSD, var_rest_froot),
    
    # Calculation **********
    # Scenario 1
    RaGpp = RaGpp_rest,
    # Scenario 2
    RaGpp2 = RaGpp_df * df_area + RaGpp_ef * ef_area + RaGpp_mf * mf_area + 
      RaGpp_gra * gra_area + RaGpp_rest * (1 - df_area - ef_area - mf_area - gra_area),
    
    # get Froot (weight by area of ecosystem type)
    Froot2 = Froot_df * df_area + Froot_ef * ef_area + Froot_mf * mf_area +
      Froot_rest * (1 - df_area-ef_area-mf_area),
    
    Ra1 = GPP_raw * RaGpp, # first way to calculate Ra, Ra = GPP * RaGPP
    Ra2 = GPP_raw - NPP, # second way to calculate Ra, Ra = GPP - NPP
    Ra3 = if_else(Ra2 < 0, Ra1, Ra2),
    Ra_avg1 = (Ra1 + Ra3) / 2,
    
    Rroot = Ra_avg1 * Froot2,
    Rshoot = Ra_avg1 * (1 - Froot2),
    Rs_topdown = NPP - HerbComsum - Fire - sink + Rroot,
    
    # Scenario 2
    Ra4 = GPP_raw * RaGpp2, # first way to calculate Ra, Ra = GPP * RaGPP
    Ra_avg2 = (Ra4 + Ra3) / 2,
    Rroot2 = Ra_avg2 * Froot2,
    Rshoot2 = Ra_avg2 * (1 - Froot2),
    Rs_topdown2 = NPP - HerbComsum - Fire - sink + Rroot2
  ) ->
  rs_results
```

## RSG results {.tabset .tabset-fade .tabset-pills}
### Scenario 1 - ratio __not__ weighted by ecosystem
```{r rsg-scenario1, results='asis'}
# Scenario 1. RaGPP ratio not separated
rsg_qt <- quantile(rs_results$Rs_topdown, QUANTILES) %>% round(0)
rsg_qt_raw <- quantile(rs_results$Rs_raw, QUANTILES) %>% round(0)

rs_results %>%
  select(`Rs implied by GPP` = Rs_topdown, `Bottom-up Rs` = Rs_raw) %>% 
  gather(Rs_type) ->
  rs_figure_data

rs_figure_data %>% 
  ggplot(aes(value, fill = Rs_type)) +
  theme_cowplot() +
  geom_density(stat = 'density', alpha = 0.5) +
  theme(legend.position = c(0.75, 0.35)) +
  coord_cartesian(xlim = c(50, 120)) +
  # reverse the color scale so that teal (color 1) is always observations, 
  # while pink is always implied fluxes
  scale_fill_discrete("", h.start = 180) + scale_color_discrete(h.start = 180) +
  ylab("Density") +
  xlab(expression(R[S]~(Pg~C~yr^{-1}))) ->
  rs_base_figure

p_rs <- p_rs + theme(text = element_text(size = 9),
                     axis.text = element_text(size = 9))
p_rs_marg <- ggMarginal(p_rs, type = "densigram", margins = "y", fill = "red")

p2_rs <- ggdraw() +
  draw_plot(rs_base_figure) +
  draw_plot(p_rs_marg, x = 0.6, y = 0.5, width = 0.4, height = 0.5)
print(p2_rs)

cat("\n\nRs implied by GPP quantiles: ", rsg_qt, "\n")
cat("\n\nBottom-up Rs quantiles: ", rsg_qt_raw, "\n")
ggsave("outputs/Figure1_rs.jpg", width = 8, height = 4)
```

### Scenario 2 - ratio __weighted__ by ecosystem
```{r rsg-scenario2, results='asis'}
# Scenario 2. RaGPP ratio separated into 2 groups
rsg_qt <- quantile(rs_results$Rs_topdown2, QUANTILES) %>% round(0)
rsg_qt_raw <- quantile(rs_results$Rs_raw, QUANTILES) %>% round(0)

rs_results %>%
  select(`Rs implied by GPP` = Rs_topdown2, `Bottom-up Rs` = Rs_raw) %>% 
  gather(Rs_type) ->
  rs_figure_data

p2_rs2 <- ggdraw() +
  draw_plot(rs_base_figure %+% rs_figure_data) +
  draw_plot(p_rs_marg, x = 0.6, y = 0.5, width = 0.4, height = 0.5)
print(p2_rs2)

cat("\n\nRs implied by GPP quantiles: ", rsg_qt, "\n")
cat("\n\nBottom-up Rs quantiles: ", rsg_qt_raw, "\n")
ggsave("outputs/Figure1_rs_weighted.jpg", width = 8, height = 4)
```


### Scenario 3 - SRDB Rs:GPP ratios
```{r SRDB Rs:GPP ratios for RSG, results='asis'}
# Calculation are the same as above

ratio_results %>%
  select(`Rs implied by SRDB Rs:GPP` = Rs, `Bottom-up Rs` = Rs_raw) %>% 
  gather(Rs_type) ->
  rs_ratio_figure_data

p1_rsg3 <- ggdraw() +
  draw_plot(rs_base_figure %+% rs_ratio_figure_data) +
  draw_plot(p_gpp_marg, x = 0.6, y = 0.5, width = 0.4, height = 0.5) 
print(p1_rsg3)

cat("\n\nGPP implied by Rs quantiles: ", gpp_qt, "\n")
cat("\n\nTop-down GPP quantiles: ", gpp_qt_raw, "\n")
ggsave("outputs/Figure1_gpp_simple.jpg", width = 8, height = 4, dpi = 300, units = "in")
```

### RSG and components relationship
```{r}
# Ra1 ~ Ra2
ggplot(rs_results, aes(x = Ra1)) +
  geom_histogram(col = "black", fill = "gray", bins = 30) +
  geom_histogram(aes(Ra3), col = "blue", fill = "skyblue", bins = 30, alpha = 0.5) +
  xlab(expression(Ra1~or~Ra3~"("~Pg~C~yr^{-1}~")")) +
  ylab(expression(count))

# Rs ~ GPP
ggplot(rs_results, aes(GPP_raw, Rs_topdown)) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression(GPP~(Pg~C~yr^{-1}))) +
  ylab(expression(R[S]~(Pg~C~yr^{-1})))

# Rs ~ NPP
ggplot(rs_results, aes(NPP, Rs_topdown)) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression(NPP~(Pg~C~yr^{-1}))) +
  ylab(expression(R[S]~(Pg~C~yr^{-1})))

# Rs ~ RaGpp
ggplot(rs_results, aes(RaGpp, Rs_topdown)) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression(R %/% GPP~(Pg~C~yr^{-1}))) +
  ylab(expression(R[S]~(Pg~C~yr^{-1})))

# Rs ~ Froot
ggplot(rs_results, aes(Froot2, Rs_topdown)) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression(Froot)) +
  ylab(expression(R[S]~(Pg~C~yr^{-1})))

# Rs ~ Fire
ggplot(rs_results, aes(Fire, Rs_topdown)) +
  geom_hex() +
  scale_fill_gradient(low = "gray", high = "blue") +
  geom_smooth(method = "lm") +
  xlab(expression(Fire~burned~(Pg~C~yr^{-1}))) +
  ylab(expression(R[S]~(Pg~C~yr^{-1})))
```

### RSG probability of agreement

```{r compute proportion of agreement between top-down RSG and bottom-up RSG, cache=FALSE}
p_Rs1 <- prob_agreement(rs_results$Rs_topdown, rsg_qt_raw)
p_Rs2 <- prob_agreement(rs_results$Rs_topdown2, rsg_qt_raw)
p_Rs3 <- prob_agreement(ratio_results$Rs, rsg_qt_raw)
p_Rs1_tt <- t_test(rs_results$Rs_raw, rs_results$Rs_topdown)
p_Rs2_tt <- t_test(rs_results$Rs_raw, rs_results$Rs_topdown2)
p_Rs3_tt <- t_test(rs_results$Rs_raw, ratio_results$Rs)
```

Scenario                 | Agreement (quantiles) | p-value (t.test)
------------------------ | --------------------- | -----------------
1 (no weighting)         | `r p_Rs1 * 100` %     | `r p_Rs1_tt`
2 (weighting)            | `r p_Rs2 * 100` %     | `r p_Rs2_tt`
3 (simple global Rs:GPP) | `r p_Rs3 * 100` %     | `r p_Rs3_tt`


## Topdown and bottomup comparison - Figure 1
```{r combine GPP and RSG comparison into figure 2, fig.height=7, fig.width=8, cache=FALSE}
# Scenario 2, RC separate into 4 groups, and Froot separate into 2 groups
plot_grid(p1_gpp2, p2_rs2, ncol = 1, labels = c("(a)", "(b)"), hjust = 0)
ggsave("outputs/Figure1.png")
```


## Combining GPP and Rs

What's the most likely values for GPP and R[S] that are consistent with the underlying distributions?

```{r joint, results='show'}
n_points <- 20
# w is the weight of top-down GPP dominance, 0 to 1
w <- seq(0, 1, length.out = 20)
w <- c(0.25, 0.5, 0.75, w) %>% unique() %>% sort()  # ensure 0.25, 0.5, and 0.75 are included

gpp_wm <- tibble(q025 = rep(NA_real_, n_points), 
                 q500 = rep(NA_real_, n_points),
                 q975 = rep(NA_real_, n_points))
rs_wm  <- gpp_wm

for(i in seq_along(w)) {
  weighted_gpp <- gpp_results$GPP_raw * w[i] + gpp_results$GPP2 * (1 - w[i])
  gpp_wm[i,] <- quantile(weighted_gpp, probs = QUANTILES)
  weighted_rs <- rs_results$Rs_raw * (1 - w[i]) + rs_results$Rs_topdown2 * w[i]
  rs_wm[i,] <- quantile(weighted_rs, probs = QUANTILES)
}
gpp_wm$w <- w
rs_wm$w <- w
results <- bind_rows("GPP" = gpp_wm, "Rs" = rs_wm, .id = "which")

results_w75 <- filter(results, w == 0.75)
results_w50 <- filter(results, w == 0.5)
results_w25 <- filter(results, w == 0.25)
myarrow <- arrow(length = unit(0.05, "inches"))

p_joint <- ggplot(results, aes(w, q500, color = which)) +
  geom_vline(xintercept = 0.5, size = 0.25, linetype = 2) +
  
  geom_line(size = 1.5) +
  geom_ribbon(aes(fill = which, ymin = q025, ymax = q975), 
              color = NA, alpha = 0.25, show.legend = FALSE) + 
  coord_cartesian(ylim = c(50, 170), expand = FALSE) +
  scale_color_discrete("", labels = c("GPP", expression(R[S]))) +
  theme(legend.text.align = 0) +
  
  # 75%
  geom_segment(data = results_w75, aes(x = 0, xend = w, yend = q500),
               linetype = 2, size = 0.5) +
  geom_label(data = results_w75, aes(x = 0.125, y = q500, label = round(q500, 0)),
             size = 2, show.legend = FALSE) +
  # 50%
  geom_segment(data = results_w50, aes(x = 0, xend = w, yend = q500), 
               linetype = 2, size = 1) +
  geom_label(data = results_w50, aes(x = 0.075, y = q500, label = round(q500, 0)),
             size = 3.5, fontface = "bold", show.legend = FALSE) +
  
  # 25%
  geom_segment(data = results_w25, aes(x = 0, xend = w, yend = q500),
               linetype = 2, size = 0.5) +
  geom_label(data = results_w25, aes(x = 0.025, y = q500, label = round(q500, 0)),
             size = 2, show.legend = FALSE) +
  
  # Arrows and labels
  annotate("segment", x = 0.1, xend = 0.025, y = 60, yend = 60, arrow = myarrow) +
  annotate("text", x = 0.11, y = 60, size = 3, hjust = "inward",
           label = expression(bold(Determined~more~by~R[S]))) +
  annotate("segment", x = 0.9, xend = 0.975, y = 60, yend = 60, arrow = myarrow) +
  annotate("text", x = 0.89, y = 60, size = 3, hjust = "inward", fontface = "bold",
           label = "Determined more by GPP") +
  
  # Other
  xlab("Weight of GPP") +
  ylab(expression(Flux~(Pg~C~yr^-1)))

print(p_joint)
ggsave("outputs/Figure3.png")
knitr::kable(results_w50, digits = 1, format = "markdown")
```


## Site-specific ratios of GPP to Rs

Presumably, as a matter of mathematics, the ratio of global Rs to global GPP should be the linear combination (sum) of all terrestrial points Neither SRDB nor FLUXNET is an unbiased sample of the land surface, but it may be instructive to look at the Rs:GPP for three data sources:

* Global GPP estimates, comparing them against the mean Rs estimate (~85 Pg C);
* the SRDB itself, for sites at which both GPP and Rs were measured;
* and FLUXNET2015 Tier 1, using Rs data measured very close to the towers.

```{r, site-ratios, results='show'}
topdown <- data.frame(GPP = GPP$GPP, Rs = mean(GlobalRs$Rs))
topdown$Source <- paste0("Global GPP\n(N = ", nrow(topdown), ")")
topdown$Type <- "Global"

srdb_v4 %>% 
  filter(!is.na(GPP), !is.na(Rs_annual), Ecosystem_state != "Managed") %>% 
  select(Rs = Rs_annual, GPP, Biome, Ecosystem_type) ->
  srdb
srdb$Source <- paste0("SRDB\n(N = ", nrow(srdb), ")")
srdb$Type <- "Observations"

read.csv("data/site-data-temp/srdb_filtered.csv", stringsAsFactors = FALSE) %>% 
  select(Biome, Ecosystem_type, FLUXNET_SITE_ID, GPP = gpp_fluxnet, Rs = Rs_annual) %>% 
  filter(!is.na(GPP), !is.na(Rs)) ->
  fluxnet
fluxnet$Source <- paste0("FLUXNET\n(N = ", nrow(fluxnet), ")")
fluxnet$Type <- "Observations"

cmip6_data_file <- "data/CMIP/1.cmip6_global_monthly_means.csv"
if(file.exists(cmip6_data_file)) {
  read.csv(cmip6_data_file, stringsAsFactors = FALSE) %>% 
    as_tibble() %>% 
    filter(model != "IPSL-CM6A-LR") %>% 
    select(era, model, experiment, ensemble, variable, time, value, LandArea) %>% 
    mutate(year = floor(time / 10000)) %>% 
    group_by(era, variable, model, experiment, ensemble, year) %>% 
    # units are kgC/m2/s, one month per row; need to go to PgC/yr
    summarise(value = sum(value * LandArea * 1000 * 60 * 60 * 24 * 365 / 1e15 / 12)) -> 
    model_data
  
  model_data %>% 
    filter(variable != "gpp") %>% 
    group_by(era, model, experiment, ensemble, year) %>% 
    summarise(variable = "Rs", 
              value = sum(value)) %>% 
    bind_rows(filter(model_data, variable == "gpp")) %>% 
    spread(variable, value) %>% 
    filter(year >= 2005) %>% 
    group_by(era, model, experiment, ensemble) %>% 
    summarise(gpp = mean(gpp), Rs = mean(Rs)) ->
    model_ratios
  
  model_ratios %>% 
    mutate(GPP = gpp, Source = paste0("CMIP5/6\n(N = ", nrow(model_ratios), ")"), Type = "Models") ->
    cmip
} else {
  cmip <- data.frame(Source = "CMIP6\n(N = 0)", Type = "Models", stringsAsFactors = FALSE)
}

bind_rows(topdown, srdb, fluxnet, cmip) %>% 
  mutate(Ratio = Rs / GPP,
         Source = factor(Source, unique(Source)[c(2, 3, 1, 4)])) ->
  ratios

ratios %>% 
  group_by(Source) %>% 
  summarise(Ratio = round(median(Ratio, na.rm = TRUE), 3)) %>%
  knitr::kable(type = "markdown")

p_ratios <- ggplot(ratios, aes(Source, Ratio, color = Type)) + 
  geom_boxplot() +
  #  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), size = 0.75) +
  # geom_jitter(alpha = I(0.25)) + 
  geom_quasirandom(alpha = I(0.25)) +
  ylab("Ratio of Rs to GPP") + xlab("") +
  coord_cartesian(ylim = c(0, 2)) #+
#  geom_label()
print(p_ratios)

ggsave("outputs/Figure2.png")
```

Note that the arithmetic mean of Rs:GPP in SRDB is `r round(Rs_to_GPP_unweighted, 3)` (median `r round(median(srdb_v4$Rs_annual / srdb_v4$GPP, na.rm = TRUE), 3)`), while the weighted (by area of ecosystem types globally) is `r round(Rs_to_GPP_weighted, 3)`. This close agreement implies that SRDB is in fact a pretty good representation of the land surface (and/or that Rs:GPP doesn't vary much).


## Other diagnoses
```{r diagnoses}
# check
gpp_results %>% transmute(check = (1 - Froot) / Froot - FsFr)

rs_results$Ra2 %>% min(na.rm = TRUE)
rs_results$Ra3 %>% min(na.rm = TRUE)

# check Froot (root-to-Rs ratio)
Froot %>% transmute (check = Froot + Fshoot) %>% max
Froot %>% transmute (check = Froot + Fshoot) %>% min
Froot %>% group_by(Ecosystem) %>% summarise(count = n())

Froot %>% count(IGBP2) 
Froot %>% count(Ecosystem) 
mean(Froot$Froot)
```


### Abstract
```{r Calculation for SI}
slope_Rs <- coefficients(summary( lm(Rs ~ Pub_year, data = GlobalRs) ))[2,1] %>% round(2)
slope_GPP <- coefficients(summary( lm(GPP ~ Pub_year, data = GPP) ))[2,1] %>% round(2)
```

Terrestrial plants sequestrate carbon from atmosphere through photosynthesis (i.e., gross primary productivity, GPP); correspondingly, roughly same amount of carbon was decomposed and returned back to the atmosphere by respiratory flexes. There’s been lots of progress in quantifying and constraining global GPP using satellite data products and upscaled flux data (Top-down approach). Global scale respiration estimates are generally derived from scaling site scale measurements across the globe (bottom-up approaches). However, the inconsistency between these estimates have not been evaluated, the inherent causes need be explored for better understanding terrestrial carbon cycling under global climate change.   

Here, we collected historical global GPP estimates (which are almost all “top-down”, fundamentally driven by satellite products and FLUXNET measurements), partitioning these values into their net primary production (NPP) and autotrophic respiration components, and calculated the implied resulting global soil respiration (RSG, `r round(mean(rs_results$Rs_topdown2), 0)`±`r round(sd(rs_results$Rs_topdown2), 0)` (Pg C yr-1), mean±sd, same here after), with only `r p_Rs2 * 100` % probability that this GPP-driven RSG estimates are consistent with previous bottom-up RSG estimates from the literature, which averaged `r round(mean(rs_results$Rs_raw), 0)`±`r round(sd(rs_results$Rs_raw), 0)` Pg C yr-1. In a second step, we partitioned bottom-up RSG values into shoot and root respiration, and calculated the resulting implied global GPP (`r round(mean(gpp_results$GPP2), 0)`±`r round(sd(gpp_results$GPP2), 0)` Pg C yr-1), with only `r p_gpp2 * 100`% probability these values are consistent with top-down global GPP estimates, which averaged `r round(mean(gpp_results$GPP_raw), 0)`±`r round(sd(gpp_results$GPP_raw), 0)` Pg C yr-1.    

Our findings highlight the inconsistence between bottom-up and top-down based GPP and RSG estimates that have a ~20 Pg C gap between them. The reasons of the inconsistency need further study for better understanding global terrestrial carbon cycling in the future.


### Text for supplemental information  
Soil respiration consumed the photosynthetic carbon assimilation, which was fixed by plant, or called gross primary production (GPP). Plant autotrophic respiration (including leaf respiration and stem respiration (Rshoot) and root respiration (Rroot)) consumed part of GPP, the left part was called net primary productivity (NPP). Part of NPP consumed by heterotrophic respiration (Rh), other part of NPP was consumed by herbivores, burned by fire or becomes long term carbon storage (carbon sink), and the sum of root respiration (Rroot) and heterotrophic respiration (Rh) is soil respiration. Theoretically, if we know the pathway of each part of global annual GPP, we can estimate global mean annual soil respiration (top-down RSG). Similarly, if we can accurately measure each component of carbon cycle, we can estimate GPP (bottom-up GPP). Here we conducted a summary analysis of global terrestrial carbon cycling to compare and explore the consistency of top-down and bottom-up GPP and global RS estimates. To make this comparison, we evaluated two approaches to partitioning the global carbon cycle from known estimates of the various fluxes and calculated the unknowns (Figure S1–S5 and Table S1–S4). 

#### GPP implied by RSG  
In the past decades, many models have been developed to estimate global RS (bottom-up global RS estimates, n=`r nrow(GlobalRs)`, Figure S1, most of the estimates were based on the field measured RS data, e.g., SRDB). RS consists of heterotrophic respiration (Rh) and root respiration (Rroot). Despite the difficulty, many studies separated RS into Rroot and Rh and many of those Rroot-to-RS ratio (RC) have been compiled into the SRDB-V4 (Figure S2). We used all RC values from SRDB-V4 whenever it is larger than 0 and smaller than 1, totally `r nrow(var_RC)` RC values were used in this study. RC values covered 9 vegetation types, but the majority were from forest, grassland, agriculture, and shrubland, all other vegetation types only have `r var_RC %>% filter(IGBP2 == "Other") %>% nrow()` samples (Figure S2 c). 

In addition, root respiration is only part of autotrophic respiration, and the rest part is shoot respiration. Many studies have been conducted to separate Ra into Rroot and Rshoot, and thus Rroot-to-Ra ratio, Rroot-to-Rshoot ratio can be calculated. According to the bottom-up Global RS estimates, Root-to-RS ratio (RC), and Rroot-to-Rshoot ratio (data come from SRDB), Rroot and Rshoot, GPP can be calculated (bottom-up GPP, Figure S1 and equation 1-3).

We collected `r nrow(GlobalRs)` published RSG estimates from articles, with approximately half of studies reported RSG standard deviation (SD, n=`r GlobalRs %>% filter(!is.na(SD)) %>% nrow()`, Table S1) and change rate during a period (n=`r GlobalRs %>% filter(!is.na(IncreaseRate)) %>% nrow()`, Table S1). The reported RSG range from `r min(GlobalRs$Rs)` to `r max(GlobalRs$Rs)` Pg C yr-1, with an average RSG of `r mean(GlobalRs$Rs) %>% round(2)` Pg C yr-1. The RSG were published from `r min(GlobalRs$Pub_year)` to `r max(GlobalRs$Pub_year)`, and the RSG estimate showed a clear increase trend from the earlier years to the modern year (increase rate = `r slope_Rs` Pg C yr-2, Figure S1 b). However, this rate is much higher than the average increase rate reported by previous studies (mean = `r round(mean(GlobalRs$IncreaseRate, na.rm=T), 2) ` Pg C yr-2, n=`r GlobalRs %>% filter(!is.na(IncreaseRate)) %>% nrow()`, Figure S1 c).

Then Rshoot can be calculated based on the Rroot and Rroot-to-Rshoot ratio, finally, bottom-up GPP can be calculated (Figure S1). We then compare the bottom-up GPP with GPP from publication in the past decades (top-down GPP) to determine the consistency between the bottom-up and top-down GPP. The following equations were used to calculate GPP from RSG:

__Equations (1 to 3)__  
Rroot = Rs × Rroot-Rs ratio (i.e., RC in SRDB)     (1)  
Rshoot = Rroot × Rroot-Rshoot ratio     (2)  
GPP = NPP + Rroot + Rshoot     (3)                                                             


#### RSG implied by GPP

Many efforts have been made to estimate GPP based on both remote sensing and FLUXNET data in the past decades (n=`r nrow(GPP)`, Figure S1). We collected `r nrow(GPP)` GPP estimates from published articles, with only `r GPP %>% filter(!is.na(SD)) %>% nrow()` of estimates reported corresponding SD, and `r GPP %>% filter(!is.na(Trend)) %>% nrow()` estimates reported corresponding trend during a period (Table S2). The reported GPP estimates were from `r min(GPP$Pub_year)` to `r max(GPP$Pub_year)`, ranged from `r min(GPP$GPP)` to `r max(GPP$GPP)` Pg, and with an average of `r mean(GPP$GPP) %>% round(2)` Pg C yr-1. There is a clear positive relationship between GPP and estimate-year, with an increase rate of `r slope_GPP` Pg C yr-2, Figure S1 e), which is bigger than the mean of reported increase rates (`r mean(GPP$Trend, na.rm=T) %>% round(2)` Pg C yr-2, Figure S1 f). Furthermore, the extreme high (`r max(GPP$GPP)` Pg) and low (`r min(GPP$GPP)` Pg) GPP estimates does not affect the overall mean GPP, as the average does not change when both extreme high and low GPP values were excluded.

GPP can be further separated into NPP, carbon consumed by herbivore, carbon burned by fire, carbon going to terrestrial as carbon sink, and carbon consumed by autotrophic respiration (Ra). Global NPP estimates were directly from a previous meta-analysis (Table S3 and Figure S2 a). Based on 251estimates (Table S2), global annual mean NPP from 1862 to 2011 was `r mean(NPP$NPP) %>% round(2)` Pg C yr-1 (±`r sd(NPP$NPP) %>% round(2)`, SD). In order to estimate Rh, we collected published estimates on NPP going to the terrestrial (Csink), NPP components burned by fire, and NPP components consumed by herbivores (Table S3). When substract carbon consumed by herbivores, fire, and land sink from NPP, global Rh between 1961 and 2014 can be estimated (Rh = NPP - Herbivores - Csink – Fire, Figure S1 and Table S1-S3). 

The difference between GPP and NPP is autotrophic respiration (Ra), Ra is a major component of the terrestrial carbon cycling and it consumes a major part of plants sequestrated carbon by photosynthesis (GPP). Ra-to-GPP-ratio is required to estimate Ra based on GPP. Ra-to-GPP-ratio used in this study were from two sources: (1) We conducted a literature search and collected `r nrow(RaGPP)` Ra-to-GPP-ratio estimates (Table S5); (2) We obtained additional `r nrow(var_RaGpp) - nrow(RaGPP)` Ra-to-PP-ratio estimates from SRDB-V4. Ra-to-GPP-ratio used in this study covered 9 vegetation types, but mainly from forest and grassland, all the other vegetation types only have `r var_RaGpp %>% filter(IGBP2 =="Other") %>% nrow()` samples (Figure S4).

Autotrophic respiration (Ra) consists of root respiration (Rroot) and shoot respiration (Rshoot), Rroot-to-Ra ratio is required to separate Ra into Rroot and Rshoot. 
Rroot-to-Ra ratio used in this study were from two sources: (1) We collected `r nrow(FlFsFr)` Rroot-to-Ra ratio estimates from `r FlFsFr %>% count(Reference) %>% nrow()` studies (Table S4); (2) We obtained additional `r nrow(Froot) - nrow(FlFsFr)` Rroot-to-Ra ratio estimates from SRDB-V4 (Table S4). Rroot-to-Ra ratio covered 7 vegetation types (Figure S3), but mainly from forest, all other vegetation types only have `r Froot %>% filter(IGBP2 == "Other") %>% nrow()` samples. 

Finally, according to the top-down GPP, NPP, Ra-to-GPP ratio, Rroot-to-Ra ratio, and Rshoot-to-Ra ratio, GPP can be separated into Rh, Rshoot, and Rroot, and thus, global RS can be calculated (Up-panel in Figure S1 and equations 4-10). We then compare the top-down RSG with RSG from publication in the past decades (bottom-up RSG) to determine the consistency between the bottom-up and top-down RSG.

__Equations (4 to 10)__  
Ra = GPP – NPP     (4)
Ra = ecosystem-respiration – heterotrophic-respiration     (5)
Ra = GPP × Ra-GPP ratio     (6)  
Rh = NPP - Fire_C - Herb_C     (7)
Rroot = Ra × Rroot-Ra ratio     (8)  
Rshoot = Ra × Rshoot-Ra ratio     (9)
Rs = Ra + Rh     (10)


_**Bootstrap resampling**_  
We used a bootstrap resampling approach to get the best estimate for each component in the bottom-up and top-down process. Sample size of each component in the bottom-up and top-down approach is different, and many of them do not following normal distribution (Figure S1-S4). We thus used a boosting resampling approach to regenerate the samples for each component (details please see the Github repository). For the Rroot-to-RS-ratio (RC), Rroot-to-Ra-ratio, and Ra-to-GPP ratio, we further separated them by ecosystem types, and weighted by their area (area of each ecosystem were from the IGBP ecosystem land classification, https://climatedataguide.ucar.edu/climate-data/ceres-igbp-land-classification).


_**Components important analysis**_

```{r not used}
# Each row gets the closest latitude and longitude values to AGB and SOC data
# AGB$Latitude[which.min(abs(61.85 - AGB$Latitude))]
# Froot %>% mutate(Latitude = round(Latitude*2, 0)/2 - 0.25, Longitude = round(Longitude*2, 0)/2-0.25) -> Froot
# there are no clear relationship between Froot and above-ground biomass or soil organic carbon (SOC)
# left_join(Froot, AGB) %>% ggplot() + aes(RASTERVALU, Froot) + geom_point()
# left_join(Froot, SOC) %>% ggplot() + aes(RASTERVALU, Froot) + geom_point()

# Each row get the closese latitude and longitude values to AGB and SOC data
# AGB$Latitude[which.min(abs(61.85 - AGB$Latitude))]
# Froot %>% mutate(Latitude = round(Latitude*2, 0)/2 - 0.25, Longitude = round(Longitude*2, 0)/2-0.25) -> Froot
# there are no clear relationship between Froot and above-ground biomass or soil organic carbon (SOC)
# left_join(Froot, AGB) %>% ggplot() + aes(RASTERVALU, Froot) + geom_point()
# left_join(Froot, SOC) %>% ggplot() + aes(RASTERVALU, Froot) + geom_point()


# Rs raw data plot
# rsg_qt <- quantile(rs_results$Rs_raw, QUANTILES) %>% round(0)
# plot_rs_raw <- ggplot(rs_results) + aes(Rs_raw) + geom_histogram(col = "black", fill = "gray", bins = 30) + 
#   geom_vline(xintercept = c(quantile (rs_results$Rs, QUANTILES)),col = "red", linetype = "dotted", size = 1.5) +
#   annotate("text", x = quantile(rs_results$Rs, 0.98), y = 5000, label = paste0("95%CI (", rsg_qt[1],", ", rsg_qt[2], ", ", rsg_qt[3], ")"), hjust = 0)
```
